name: CI

on:
  push:
    branches: [master]

jobs:
  build:
    id: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: discover
        run: ls -latr
      - name: Get latest link
        id: link
        run: |
          sudo apt-get update && sudo apt-get install -y lynx
          url=$(curl -s 'https://www.amd.com/en/support/chipsets/amd-socket-am4/b450' \
          -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:82.0) Gecko/20100101 Firefox/82.0' \
          | lynx -stdin -dump | grep -m 1 drivers.amd.com/drivers/amd_chipset_software_ | cut -d ' ' -f 3)
          echo $url
          echo ::set-output name=url::$url
      - name: update chocolateyinstall.ps1
        id: update
        shell: pwsh
        env:
          LINK: ${{ steps.link.outputs.url }}
        run: |
          $FileName = ($ENV:LINK -split '/')[-1]
          $Version = $ENV:LINK | sls -pattern "\d+\.\d+.\d+\.\d+" -AllMatches | % {$_.matches.value}
          Invoke-Webrequest -UseBasicParsing `
                            -OutFile $FileName `
                            -Headers @{Referer = 'https://www.amd.com/en/support/chipsets/amd-socket-am4/b450'} `
                            -Uri $ENV:LINK 
          $Hash = Get-FileHash 'amd_chipset_software_2.10.13.408.exe' -Algorithm 'SHA256' | Select-Object -ExpandProperty Hash

          $chocoInstLoc = './amd-ryzen-chipset/tools/chocolateyinstall.ps1'
          $chocoInst    = Get-Content $chocoInstLoc -raw
          $chocoInst    = $chocoInst -replace '[a-zA-Z0-9]{64}',$Hash
          $chocoInst    = $chocoInst -replace "'https://drivers.amd.com/drivers/.*'","'$ENV:LINK'"
          $chocoInst | Out-File $chocoInstLoc

          cat $chocoInstLoc

          write-host "::set-output name=newversion::false"
  publish:
    if: jobs.build.steps.update.outputs.newversion == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Commit changes
        uses: EndBug/add-and-commit@v5
        with:
          branch: version
          message: "Automated update to version xxx"
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
